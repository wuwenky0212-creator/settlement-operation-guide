# 实施计划：操作指导功能

## 概述

本实施计划将操作指导功能的设计转化为一系列可执行的编码任务。任务按照增量方式组织，每个任务都建立在前面任务的基础上，最终完成整个系统的实现。

实现技术栈：
- 后端：Python (Flask/FastAPI)
- 前端：Vue.js
- 数据库：关系型数据库（MySQL/PostgreSQL）
- 测试：Pytest + Hypothesis (属性测试)

## 任务列表

- [x] 1. 搭建项目基础架构
  - 创建后端项目结构（Python）
  - 创建前端项目结构（Vue.js）
  - 配置数据库连接
  - 设置测试框架（Pytest + Hypothesis）
  - _需求：功能8_

- [x] 2. 实现数据模型和数据库层
  - [x] 2.1 创建数据库表结构
    - 创建交易表（transactions）
    - 创建事件表（events）
    - 创建账务表（accounting_records）
    - 创建现金流表（cash_flows）
    - 添加索引和约束
    - _需求：功能1, 功能2, 功能3, 功能4, 功能5, 功能8_
  
  - [x] 2.2 实现数据模型类
    - 实现Transaction、EventRecord、AccountingRecord、CashFlow数据类
    - 实现枚举类型（ProductType、TransactionStatus等）
    - _需求：功能1, 功能2_
  
  - [ ]* 2.3 编写数据模型属性测试
    - **属性5: 交易详情完整性**
    - **验证：功能2.5**
  
  - [x] 2.4 实现仓储层（Repository）
    - 实现TransactionRepository
    - 实现EventRepository
    - 实现AccountingRepository
    - 实现CashFlowRepository
    - _需求：功能1, 功能2, 功能3, 功能4, 功能5_
  
  - [ ]* 2.5 编写仓储层属性测试
    - **属性37: 数据持久化一致性**
    - **验证：功能9.1**

- [x] 3. 实现并发控制机制
  - [x] 3.1 实现乐观锁机制
    - 实现ConcurrencyControl类
    - 实现版本号检查逻辑
    - _需求：功能8_
  
  - [ ]* 3.2 编写并发控制属性测试
    - **属性38: 并发更新冲突检测**
    - **验证：功能9.4**
    - **属性39: 并发读取不阻塞**
    - **验证：功能9.6**
    - **属性40: 事务原子性**
    - **验证：功能9.7**

- [x] 4. 检查点 - 确保数据层测试通过
  - 确保所有数据层测试通过，询问用户是否有问题

- [x] 5. 实现查询服务
  - [x] 5.1 实现交易查询服务
    - 实现QueryService类
    - 实现query_transactions方法（支持多条件查询）
    - 实现get_transaction_detail方法
    - 实现分页逻辑
    - _需求：功能1, 功能2_
  
  - [ ]* 5.2 编写交易查询属性测试
    - **属性1: 查询条件组合处理**
    - **验证：功能1.1**
    - **属性2: 查询结果排序一致性**
    - **验证：功能1.2**
    - **属性3: 分页参数正确应用**
    - **验证：功能1.3, 1.5**
  
  - [x] 5.3 实现现金流查询服务
    - 实现query_cash_flows方法
    - 实现get_cash_flow_detail方法
    - _需求：功能8_
  
  - [ ]* 5.4 编写现金流查询属性测试
    - **属性23: 现金流查询条件处理**
    - **验证：功能8.1**
    - **属性24: 现金流记录完整性**
    - **验证：功能8.2, 8.3**
    - **属性25: 现金流金额汇总正确性**
    - **验证：功能8.6**

- [x] 6. 实现事件服务
  - [x] 6.1 实现事件查询和记录
    - 实现EventService类
    - 实现query_events方法
    - 实现record_event方法
    - _需求：功能3_
  
  - [ ]* 6.2 编写事件服务属性测试
    - **属性6: 事件记录字段完整性**
    - **验证：功能3.1**
    - **属性7: 事件记录排序一致性**
    - **验证：功能3.2**

- [x] 7. 实现账务服务
  - [x] 7.1 实现账务查询服务
    - 实现AccountingService类
    - 实现get_payment_info方法
    - 实现query_accounting_records方法
    - 实现金额汇总逻辑
    - _需求：功能4, 功能5_
  
  - [ ]* 7.2 编写账务服务属性测试
    - **属性8: 账务信息完整性**
    - **验证：功能4.1, 4.2, 4.3**
    - **属性9: 支付记录列表完整性**
    - **验证：功能4.4**
    - **属性10: 账务记录字段完整性**
    - **验证：功能5.1**
    - **属性11: 账务记录排序一致性**
    - **验证：功能5.2**
    - **属性12: 账务金额汇总正确性**
    - **验证：功能5.6**

- [x] 8. 检查点 - 确保业务服务测试通过
  - 确保所有业务服务测试通过，询问用户是否有问题

- [x] 9. 实现状态跟踪服务
  - [x] 9.1 实现交易生命周期跟踪
    - 实现StatusTrackingService类
    - 实现get_transaction_progress方法
    - 实现状态识别逻辑
    - 实现流程路径判断逻辑
    - _需求：功能6_
  
  - [ ]* 9.2 编写交易生命周期属性测试
    - **属性13: 生命周期阶段识别准确性**
    - **验证：功能6.1**
    - **属性14: 状态回执顺序一致性**
    - **验证：功能6.2**
    - **属性15: 流程路径条件正确性**
    - **验证：功能6.3**
    - **属性16: 阶段状态明确性**
    - **验证：功能6.4**
    - **属性17: 失败节点原因完整性**
    - **验证：功能6.5**
    - **属性18: 流程图数据结构正确性**
    - **验证：功能6.6**
  
  - [x] 9.3 实现结算支付进度跟踪（4阶段流程）
    - 实现get_cash_flow_progress方法
    - 实现结算支付阶段识别逻辑（清算轧差/合规准入/结算执行/结算撤销）
    - 实现SWIFT路径串行逻辑（RMC→FTM）
    - 实现CBMNet路径人工确认逻辑
    - _需求：功能7_
  
  - [ ]* 9.4 编写结算支付进度属性测试
    - **属性26: 结算支付阶段识别准确性**
    - **验证：功能7.1**
    - **属性27: 结算支付流程路径条件正确性**
    - **验证：功能7.2**
    - **属性28: 结算支付阶段状态明确性**
    - **验证：功能7.3**
    - **属性29: 结算支付失败节点信息完整性**
    - **验证：功能7.4**
    - **属性30: 结算支付操作指引正确性**
    - **验证：功能7.5**
    - **属性31: 结算支付流程图数据结构正确性**
    - **验证：功能7.6**
    - **属性32: 清算轧差前置条件验证正确性**
    - **验证：功能7.1**
    - **属性33: 合规硬拦截机制有效性**
    - **验证：功能7.2**
    - **属性34: SWIFT传输层串行逻辑正确性**
    - **验证：功能7.3**
    - **属性35: CBMNet人工确认机制有效性**
    - **验证：功能7.3**
    - **属性36: 资金冲正闭环控制正确性**
    - **验证：功能7.4**

- [x] 10. 实现操作指引服务
  - [x] 10.1 实现操作指引生成逻辑
    - 实现OperationGuideService类
    - 实现get_transaction_guide方法
    - 实现get_cash_flow_guide方法
    - 配置操作指引规则
    - _需求：功能7（结算支付进度跟踪的操作指引）_
  
  - [ ]* 10.2 编写操作指引属性测试
    - **属性19: 操作指引动态生成正确性**
    - **验证：功能7.1（交易生命周期操作指引）**
    - **属性20: 人工处理入口完整性**
    - **验证：功能7.2（交易生命周期操作指引）**
    - **属性21: 操作指引字段完整性**
    - **验证：功能7.4, 7.5（交易生命周期操作指引）**
    - **属性22: 操作指引状态一致性**
    - **验证：功能7.6（交易生命周期操作指引）**

- [x] 11. 实现导出服务
  - [x] 11.1 实现数据导出功能
    - 实现ExportService类
    - 实现export_transactions方法（支持Excel和CSV）
    - 实现export_cash_flows方法
    - 实现流式处理逻辑
    - _需求：功能1.7_
  
  - [ ]* 11.2 编写导出服务属性测试
    - **属性4: 导出数据一致性**
    - **验证：功能1.7**

- [x] 12. 检查点 - 确保所有后端服务测试通过
  - 确保所有后端服务测试通过，询问用户是否有问题

- [x] 13. 实现REST API层
  - [x] 13.1 创建API路由和控制器
    - 创建Flask/FastAPI应用
    - 实现交易查询API端点
    - 实现交易详情API端点
    - 实现事件查询API端点
    - 实现账务查询API端点
    - 实现现金流查询API端点
    - 实现导出API端点
    - _需求：功能1, 功能2, 功能3, 功能4, 功能5, 功能8_
  
  - [x] 13.2 实现错误处理中间件
    - 实现统一错误处理
    - 实现错误响应格式化
    - 实现错误日志记录
    - _需求：所有功能_
  
  - [x] 13.3 实现权限验证中间件
    - 实现身份认证
    - 实现权限验证
    - _需求：所有功能_
  
  - [ ]* 13.4 编写API集成测试
    - 测试所有API端点的请求-响应流程
    - 测试错误处理
    - 测试权限验证

- [x] 14. 实现前端基础组件（Vue.js）
  - [x] 14.1 创建Vue项目结构
    - 初始化Vue项目
    - 配置路由（Vue Router）
    - 配置状态管理（Vuex/Pinia）
    - 配置HTTP客户端（Axios）
    - _需求：所有功能_
  
  - [x] 14.2 创建通用UI组件
    - 创建分页组件
    - 创建表格组件
    - 创建标签页组件
    - 创建加载动画组件
    - 创建错误提示组件
    - _需求：所有功能_
  
  - [x] 14.3 实现样式主题（murex风格）
    - 配置颜色方案（红色主题）
    - 实现表格斑马纹样式
    - 实现按钮样式
    - 实现标签页样式
    - _需求：所有功能_

- [x] 15. 实现交易汇总页面
  - [x] 15.1 创建交易汇总查询页面
    - 实现查询条件表单
    - 实现交易列表表格
    - 实现分页控件
    - 实现导出按钮
    - 集成API调用
    - _需求：功能1_
  
  - [ ]* 15.2 编写前端单元测试
    - 测试查询条件验证
    - 测试分页逻辑
    - 测试API调用

- [x] 16. 实现交易详情页面
  - [x] 16.1 创建交易详情弹出窗口
    - 实现弹出窗口组件
    - 实现标签页布局
    - 实现交易信息标签页
    - 实现事件信息标签页
    - 实现支付信息标签页
    - 实现账务信息标签页
    - 集成API调用
    - _需求：功能2, 功能3, 功能4, 功能5_
  
  - [x] 16.2 实现生命周期进度可视化
    - 实现流程图组件
    - 实现状态节点渲染
    - 实现进度指示器
    - _需求：功能6_
  
  - [x] 16.3 实现操作指引显示
    - 实现操作指引组件
    - 实现操作入口按钮
    - _需求：功能7_
  
  - [ ]* 16.4 编写前端单元测试
    - 测试标签页切换
    - 测试数据展示
    - 测试流程图渲染

- [x] 17. 实现现金流查询页面
  - [x] 17.1 创建现金流查询页面
    - 实现查询条件表单
    - 实现现金流列表表格
    - 实现分页控件
    - 集成API调用
    - _需求：功能8_
  
  - [x] 17.2 创建现金流详情页面
    - 实现现金流详情弹出窗口
    - 实现收付进度可视化
    - 实现操作指引显示
    - _需求：功能9_
  
  - [ ]* 17.3 编写前端单元测试
    - 测试查询逻辑
    - 测试详情展示

- [x] 18. 实现实时更新功能
  - [x] 18.1 实现状态轮询机制
    - 实现前端轮询逻辑（10秒间隔）
    - 实现状态更新通知
    - _需求：功能6, 功能9_
  
  - [ ]* 18.2 （可选）实现WebSocket推送
    - 实现WebSocket服务端
    - 实现WebSocket客户端
    - _需求：功能6, 功能9_

- [x] 19. 检查点 - 确保前端功能完整
  - 确保所有前端页面功能正常，询问用户是否有问题

- [x] 20. 集成测试和端到端测试
  - [ ]* 20.1 编写端到端测试
    - 测试完整的用户流程（查询 → 查看详情 → 导出）
    - 测试错误场景
    - 测试并发场景
  
  - [ ]* 20.2 性能测试
    - 测试查询响应时间
    - 测试并发用户负载
    - 测试导出性能

- [x] 21. 文档和部署准备
  - [x] 21.1 编写API文档
    - 使用Swagger/OpenAPI生成API文档
    - 编写API使用说明
  
  - [x] 21.2 编写部署文档
    - 编写环境配置说明
    - 编写数据库迁移脚本
    - 编写部署步骤
  
  - [x] 21.3 编写用户手册
    - 编写功能使用说明
    - 编写常见问题解答

- [x] 22. 最终检查点
  - 确保所有测试通过，询问用户是否准备好部署

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求，确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
