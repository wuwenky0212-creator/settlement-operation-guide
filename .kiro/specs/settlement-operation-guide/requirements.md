# 产品需求文档 (PRD)

## 功能概述

操作指导是GIT-RG系统中的一个核心功能模块（Settlement RN#17），用于支持按多种条件查询交易确认书并显示最新状态。该功能能够标识交易当前所处的生命周期阶段，如已证实、已清算处理待发报、已发报待接收回执等状态，并提供操作指引帮助用户进行后续处理。

## 术语表

- **交易流水号**: 唯一标识一笔交易的编号
- **发送方参考号 (Sender Reference)**: SWIFT报文中的发送方参考号
- **运营机构**: 执行交易的机构
- **方向**: 交易方向（收/付）
- **现金流内部ID**: 系统内部的现金流标识
- **收付信息ID**: 收付款信息的唯一标识
- **结算内部ID**: 结算记录的内部标识
- **RMC**: SWIFT报文路由管理中心
- **FTM**: SWIFT报文传输消息
- **SWIFT证实回执**: SWIFT系统返回的确认回执
- **证实匹配状态**: 交易确认的匹配结果状态
- **反洗钱**: 反洗钱系统检查
- **核心**: 核心银行系统
- **内部账**: 内部账户系统
- **HKSWIFT**: 香港SWIFT系统
- **pacs.008**: ISO 20022 客户贷记转账报文
- **pacs.009**: ISO 20022 金融机构贷记转账报文
- **camt.057**: ISO 20022 通知报文
- **camt.056**: ISO 20022 取消请求报文
- **camt.058**: ISO 20022 取消响应报文

## 功能需求

### 功能1: 交易汇总列表

#### 1. 功能点描述
提供交易汇总列表查询功能，支持多种查询条件组合，以列表形式展示交易记录，支持分页浏览，用户可以快速定位和查看交易。

#### 2. 前提与约束
- 用户必须拥有交易查询权限
- 支持多条件组合查询
- 查询结果支持分页显示
- 默认按交易日降序排列

#### 3. 输入描述
查询条件：
- **外部流水号** (必填): 字符串
- **交易状态** (可选): 下拉选择，枚举值包括：
  - 生效
  - 到期
  - 失效
- **交易日** (可选): 日期或日期范围，格式 YYYY-MM-DD
- **起息日** (可选): 日期或日期范围，格式 YYYY-MM-DD
- **到期日** (可选): 日期或日期范围，格式 YYYY-MM-DD
- **交易对手** (可选): 字符串，交易对手方名称或代码
- **产品** (可选): 下拉选择，枚举值包括：
  - 外汇即期
  - 外汇远期
  - 外汇掉期
  - 同业拆借
  - 货币市场存款
  - 现券买卖
  - 买断式回购
  - 质押式回购
  - 单边现金流
- **货币** (可选): 字符串，3位ISO货币代码（如 CNY、USD、EUR、HKD 等）
- **运营机构** (可选): 下拉选择，枚举值包括：
  - 1530H_中国银行(香港)有限公司
  - 052_中国银行（香港）有限公司文莱分行
  - 053_中国银行（香港）有限公司仰光分行
- **清算方式** (可选): 下拉选择，枚举值包括：
  - 全额
  - 净额
  - 集中
  - 无需
  - 我行代理
  - 他行代理
- **证实方式** (可选): 下拉选择，枚举值包括：
  - SWIFT
  - 文本
  - 无证实
- **交易来源** (可选): 下拉选择，枚举值包括：
  - GIT
  - FXO
  - FXS
  - FXY
  - FXW

#### 4. 输出描述
成功时返回：
- **交易列表**: 当前页的交易记录，每条记录包括：
  - **外部流水号**: 外部系统的交易流水号
  - **交易流水号**: 系统内部交易流水号
  - **录入日**: 交易录入系统的日期
  - **交易日**: 交易发生日期
  - **起息日**: 起息日期
  - **到期日**: 到期日期
  - **账户**: 交易账户信息
  - **产品**: 产品类型（如外汇即期、外汇远期等）
  - **买卖方向**: 买入或卖出
  - **标的物**: 交易标的物描述
  - **交易对手**: 交易对手方名称
  - **交易状态**: 当前交易状态
  - **后线处理状态**: 后线处理的当前状态
  - **清算方式**: 清算方式（如全额、净额、集中等）
  - **证实编号**: 证实确认的编号
  - **证实方式**: 证实方式（如SWIFT、文本、无证实）
  - **证实匹配方式**: 证实匹配的方式
  - **交易性质**: 交易性质描述
  - **交易来源**: 交易来源系统（如GIT、FXO等）
  - **事件类型**: 最新事件类型
  - **运营机构**: 运营机构名称
  - **交易员**: 交易员姓名
  - **操作**: 操作按钮
- **分页信息**: 
  - **当前页码**: 当前页数
  - **总页数**: 总页数
  - **记录总数**: 符合条件的记录总数
  - **当前页记录数**: 当前页显示的记录数
- **查询条件摘要**: 使用的查询条件列表

无匹配记录时返回：
- **空列表**: []
- **记录总数**: 0
- **提示信息**: "未找到符合条件的交易记录"

参数错误时返回：
- **错误信息**: 具体的参数错误描述
- **无效参数列表**: 列出所有无效的参数及原因

#### 5. 验收标准
1. 系统支持通过任意查询条件组合进行交易查询
2. 查询结果以列表形式展示，默认按交易日期降序排列
3. 支持分页显示，用户可以选择每页显示15/20/50/100条记录
4. 分页控件包含首页、上一页、下一页、末页、页码跳转功能
5. 列表显示当前页记录数和总记录数（如"显示1到20，共82记录"）
6. 用户可以点击列表中的任意交易记录查看详情
7. 支持导出查询结果为Excel或CSV格式

### 功能2: 交易详情查看

#### 1. 功能点描述
提供交易详细信息查看功能，通过多标签页方式展示交易的完整信息，包括交易信息、事件信息、账务信息、支付信息。

#### 2. 前提与约束
- 用户必须具有交易详情查看权限
- 从交易汇总列表点击进入详情页
- 详情页采用标签页（Tab）方式组织信息
- 不同标签页展示不同维度的交易信息

#### 3. 输入描述
- **外部流水号** (必填): 字符串，从交易汇总列表选择的交易标识

#### 4. 输出描述
成功时返回交易详情，包含以下标签页：

**标签页1: 交易信息**
- **交易信息**:
  - 货币对
  - 金额(USD/CNY)：BUY金额、SELL金额（带方向标识和颜色）
  - 即期汇率/点差/成本汇率
  - 分润金额、分润币种
  - 交易日、交易时间
  - 起息日
- **交易账户**:
  - 账户
  - 交易对手（代码和名称）
  - 经纪商
  - 背对背账户
- **备注**:
  - 交易性质
  - 外部流水号
  - 交易目的
  - 备注
- **拆分信息**:
  - 交易拆分：拆分货币对（复选框）
- **拆展字段**:
  - 我方收结算路径(USD)
  - 对手方付结算路径(USD)
  - 我方付结算路径(CNY)
  - 对手方收结算路径(CNY)
  - 清算方式

**标签页2: 事件信息**
- 事件流转记录列表（详见功能3）

**标签页3: 支付信息**
- 支付方式、支付账户信息等（详见功能4）

**标签页4: 账务信息**
- 账务处理详细信息（详见功能5）

未找到记录时返回：
- **错误信息**: "未找到对应的交易记录"
- **交易流水号**: 用户请求的交易流水号

#### 5. 验收标准
1. 从交易汇总列表点击交易记录后，系统打开交易详情页
2. 详情页采用标签页方式组织，包含4个标签页
3. 默认显示"交易信息"标签页
4. 用户可以自由切换标签页查看不同维度的信息
5. 每个标签页的信息完整、准确、实时
6. 详情页提供关闭按钮，关闭后返回交易汇总列表
7. 详情页加载时间在正常负载下不超过300毫秒

### 功能3: 事件信息查看

#### 1. 功能点描述
在交易详情的"事件信息"标签页中，以列表形式展示交易的所有事件流转记录，包括事件类型、发生时间、操作用户等信息，支持事件历史追溯。

#### 2. 前提与约束
- 用户必须具有事件信息查看权限
- 事件记录按时间倒序排列（最新的在前）
- 事件记录不可修改或删除
- 支持分页显示

#### 3. 输入描述
- **外部流水号** (必填): 字符串，从交易详情页自动传入，无需用户手动输入

#### 4. 输出描述
成功时返回：
- **事件记录列表**: 包含所有事件记录，每条记录包括：
  - **外部流水号**: 外部系统的交易流水号
  - **交易流水号**: 系统内部交易流水号
  - **父交易流水号**: 父交易的流水号（如有）
  - **产品**: 产品类型（如外汇即期、外汇远期等）
  - **账户**: 交易账户信息
  - **事件类型**: 事件类型（如BOOKED、PAYMENT-DAILY、MATURED等）
  - **交易状态**: 当前交易状态
  - **录入日**: 交易录入系统的日期
  - **交易日**: 交易发生日期
  - **修改日**: 最后修改日期
  - **后线处理状态**: 后线处理的当前状态
  - **证实状态**: 证实确认状态
  - **证实匹配状态**: 证实匹配的结果状态
  - **操作用户**: 执行操作的用户名
- **分页信息**:
  - **当前页码**: 当前页数
  - **总页数**: 总页数
  - **记录总数**: 事件记录总数

无事件记录时返回：
- **空列表**: []
- **提示信息**: "该交易暂无事件记录"

#### 5. 验收标准
1. 事件信息以列表形式展示，包含完整的14个字段信息
2. 事件记录按修改日降序排列（最新的在前）
3. 支持分页显示，默认每页15条记录
4. 分页控件包含首页、上一页、下一页、末页功能
5. 显示当前页记录数和总记录数（如"显示1到4，共4记录"）
6. 事件记录实时更新，反映最新的交易事件
7. 事件信息加载时间在正常负载下不超过200毫秒

### 功能4: 现金流信息查看

#### 1. 功能点描述
在交易详情的"现金流信息"标签页中，以列表形式展示交易相关的所有现金流记录，包括现金流内部ID、结算路径、收付类型、支付日、货币、金额等详细信息，帮助用户了解交易的资金流向和收付状态。

#### 2. 前提与约束
- 用户必须具有现金流信息查看权限
- 一笔交易可能对应多条现金流记录
- 现金流记录按序号排列
- 支持分页显示

#### 3. 输入描述
- **外部流水号** (必填): 字符串，从交易详情页自动传入，无需用户手动输入

#### 4. 输出描述
成功时返回：
- **现金流记录列表**: 包含所有现金流记录，每条记录包括：
  - **序号**: 现金流记录序号
  - **现金流内部ID**: 现金流的唯一标识
  - **我方结算路径**: 我方的结算路径信息
  - **对手方结算路径**: 对手方的结算路径信息
  - **结算渠道**: 结算使用的渠道
  - **交割模式**: 交割方式
  - **收付类型**: 收款或付款类型
  - **支付日**: 支付日期
  - **计划轧差日**: 计划进行轧差的日期
  - **轧差规则**: 轧差使用的规则
  - **轧差状态**: 轧差的当前状态
  - **收付状态**: 收付款的当前状态
  - **货币**: 现金流币种
  - **金额**: 现金流金额
  - **清算方式**: 清算方式
  - **现金流类型**: 现金流的类型分类
  - **收付方向**: 收入或支出方向
  - **计息开始日**: 计息的起始日期
  - **计息结束日**: 计息的结束日期
  - **阶段**: 现金流所处阶段
  - **计息基础**: 计息的基础金额或规则
  - **LEG**: 交易腿标识
  - **现金流号**: 现金流编号
  - **产品**: 产品类型
  - **外部流水号**: 外部系统的交易流水号
  - **交易流水号**: 系统内部交易流水号
- **分页信息**:
  - **当前页码**: 当前页数
  - **总页数**: 总页数
  - **记录总数**: 现金流记录总数

无现金流记录时返回：
- **空列表**: []
- **提示信息**: "该交易暂无现金流记录"

#### 5. 验收标准
1. 现金流信息以列表形式展示，包含完整的25个字段信息
2. 现金流记录按序号排列
3. 支持分页显示，默认每页15条记录
4. 分页控件包含首页、上一页、下一页、末页功能
5. 显示当前页记录数和总记录数
6. 现金流信息实时更新，反映最新的收付状态
7. 现金流信息加载时间在正常负载下不超过200毫秒

### 功能5: 账务信息查询

#### 1. 功能点描述
在交易详情的"账务信息"标签页中，以列表形式展示交易相关的所有账务记录，包括传票号、记账日、事件号、借贷方向、货币、科目、金额等信息，支持查看账务处理明细。

#### 2. 前提与约束
- 用户必须具有账务信息查看权限
- 一笔交易可能对应多条账务记录
- 账务记录按实际记账日降序排列
- 支持分页显示

#### 3. 输入描述
- **交易流水号** (必填): 字符串，从交易详情页自动传入，无需用户手动输入

#### 4. 输出描述
成功时返回：
- **账务记录列表**: 包含所有账务记录，每条记录包括：
  - **传票号**: 会计传票编号
  - **实际记账日**: 实际入账日期
  - **计划记账日**: 计划入账日期
  - **事件号**: 关联的事件编号
  - **借贷方向**: 借方或贷方标识
  - **货币**: 账务币种
  - **科目**: 会计科目
  - **交易金额**: 账务金额
- **分页信息**:
  - **当前页码**: 当前页数
  - **总页数**: 总页数
  - **记录总数**: 账务记录总数
- **金额汇总**: 按币种汇总的借贷金额

无账务记录时返回：
- **空列表**: []
- **提示信息**: "该交易暂无账务记录"

#### 5. 验收标准
1. 账务信息以列表形式展示，包含完整的8个字段信息
2. 账务记录按实际记账日降序排列（最新的在前）
3. 支持分页显示，默认每页15条记录
4. 分页控件包含首页、上一页、下一页、末页功能
5. 显示当前页记录数和总记录数
6. 提供按币种汇总的借贷金额统计
7. 账务信息实时更新，反映最新的账务处理状态
8. 账务信息加载时间在正常负载下不超过200毫秒

### 功能6: 交易进度跟踪

#### 1. 功能点描述
根据交易当前所处的生命周期阶段，实时跟踪交易从后台复核到证实匹配完成的状态进度，以可视化方式展示交易流程的完成情况。交易进度跟踪严格遵循后台复核 → SWIFT证实回执 → 证实匹配的顺序流转。

**展示位置**:
- 在交易详情页面的"交易信息"标签页底部展示交易生命周期进度跟踪组件
- 进度跟踪组件应该嵌入在交易信息内容区域内，而不是作为独立的标签页

#### 2. 前提与约束
- 用户必须具有进度查看权限
- 交易进度包含三个主要节点：后台复核 → SWIFT证实回执状态 → 证实匹配
- SWIFT证实回执状态仅适用于外汇掉期和拆借交易
- SWIFT证实回执内部遵循严格的串行回执逻辑：RMC → FTM
- RMC失败会阻断整个流程，无FTM回执
- FTM失败会触发待办补发提醒
- 进度组件应该与页面内容自然融合，保持一致的视觉风格

#### 3. 输入描述
- **交易流水号** (必填): 字符串，要查询进度的交易标识

#### 4. 输出描述
成功时返回：

**当前进度信息**:
- **当前节点**: 交易所处的具体节点名称
- **当前状态**: 当前节点的状态（复核中/已通过/已删除/发送成功/发送失败/回执失败/匹配成功/匹配失败）
- **产品类型**: 标识是否适用SWIFT证实流程

**节点1: 后台复核 (Back-office Validation)**

该节点作为流程漏斗，决定交易的去留：

1. **复核中 (In-Review)**:
   - 状态：初始状态
   - 触发条件：前台交易达成并同步至后线
   - 时间戳：交易同步时间
   - 描述：等待结算员核对交易要素与清算路径
   - 操作指引：等待结算员完成复核

2. **复核通过 (Approved)**:
   - 状态：已完成
   - 触发条件：结算员执行"确认通过"指令
   - 时间戳：复核通过时间
   - 描述：交易复核通过，触发后续证实流程
   - 后续逻辑：进入"SWIFT证实回执状态"节点

3. **交易已删除 (Deleted/Cancelled)**:
   - 状态：流程终结
   - 触发条件：结算员执行"退回/删除"指令
   - 时间戳：删除时间
   - 描述：交易已被删除，进入归档库
   - 标记：红色，显示"流程已终结"
   - 后续逻辑：流程不再流转

**节点2: SWIFT 证实回执状态 (SWIFT Confirmation Status)**

此节点为核心逻辑块，仅适用于外汇掉期和拆借交易。该节点内部遵循严格的串行回执逻辑，包含两个子节点：

**A. 内部流转逻辑**:

**子节点1: RMC 发送**
- 状态：处理中/成功/失败
- 触发条件：复核通过后自动触发
- 时间戳：发送时间

- **IF SUCCESS (RMC回执成功)**:
  - 描述：RMC 回执成功，自动触发 FTM 发送
  - 标记：绿色
  - 后续逻辑：自动进入子节点2（FTM处理）

- **IF FAILURE (RMC回执失败)**:
  - 描述：RMC 回执失败，这是阻断点
  - 标记：红色，高亮报错
  - 大节点状态：置为"回执失败"
  - 后续逻辑：系统停止后续所有动作，无 FTM 回执
  - 操作指引：报文出口受阻（RMC 失败），请检查报文规范

**子节点2: FTM 处理**
- 前提条件：RMC 必须为 SUCCESS
- 状态：处理中/成功/失败
- 触发条件：RMC 回执成功后自动触发
- 时间戳：发送时间

- **IF SUCCESS (FTM回执成功)**:
  - 描述：FTM 回执成功
  - 标记：绿色
  - 大节点状态：更新为"发送成功"
  - 后续逻辑：解锁下一流程，进入"证实匹配"节点

- **IF FAILURE (FTM回执失败)**:
  - 描述：FTM 回执失败，报文传输中断
  - 标记：黄色，提醒状态
  - 大节点状态：置为"发送失败"
  - 后续逻辑：触发"待办补发"提醒
  - 操作指引：报文传输中断（FTM 失败），请在待办中执行"补发处理"

**B. 操作指引**:

- **正常指引**:
  - 系统正在处理 SWIFT 链路回执，请稍候

- **异常指引（RMC 失败）**:
  - 报文出口受阻（RMC 失败），请检查报文规范

- **异常指引（FTM 失败）**:
  - 报文传输中断（FTM 失败），请在待办中执行"补发处理"

**节点3: 证实匹配 (Confirmation Matching)**

该节点仅在SWIFT证实回执状态大节点成功后进入：

1. **待匹配 (Pending Match)**:
   - 状态：待处理
   - 触发条件：SWIFT 回执大节点成功后自动进入
   - 时间戳：进入时间
   - 描述：等待系统或人工进行匹配处理

2. **匹配中 (Matching)**:
   - 状态：处理中
   - 触发条件：系统开始自动匹配
   - 时间戳：开始匹配时间
   - 描述：系统正在对对手方报文进行自动打分

3. **匹配成功 (Match Success)**:
   - 状态：已完成
   - 触发条件：自动匹配成功
   - 时间戳：匹配成功时间
   - 描述：证实匹配成功，流程闭环
   - 标记：绿色
   - 后续逻辑：交易进度跟踪完成

4. **手工处理 (Manual Processing)**:
   - 状态：待人工处理
   - 触发条件：自动匹配失败
   - 时间戳：转入手工处理时间
   - 描述：匹配失败，需要结算员执行人工匹配或撤销处理
   - 标记：黄色
   - 操作指引：请在待办任务中进行手工匹配或执行撤销处理

**流程可视化**:
- **进度条**: 以横向进度条方式展示三个主要节点和当前位置
- **节点层级**: SWIFT证实回执状态节点内部展示RMC和FTM两个子节点
- **已完成节点**: 标记为绿色，显示完成时间
- **当前节点**: 标记为蓝色并高亮，显示进行中状态
- **未完成节点**: 标记为灰色
- **阻断节点**: 标记为红色，高亮显示"回执失败"，明确标注无后续回执
- **待处理节点**: 标记为黄色，显示"待办补发"或"手工处理"
- **已终结节点**: 标记为红色，显示"流程已终结"

**节点状态汇总**:
- **后台复核**: 复核中 / 复核通过 / 交易已删除
- **SWIFT证实回执状态**: 处理中 / 发送成功 / 发送失败 / 回执失败
  - 子节点 RMC: 处理中 / 成功 / 失败
  - 子节点 FTM: 处理中 / 成功 / 失败（仅当RMC成功时显示）
- **证实匹配**: 待匹配 / 匹配中 / 匹配成功 / 手工处理

未找到记录时返回：
- **错误信息**: "未找到对应的交易记录"

#### 5. 验收标准
1. 系统能够准确识别交易当前所处的节点和状态
2. 交易进度严格按照预定义的顺序展示（后台复核 → SWIFT证实回执状态 → 证实匹配）
3. SWIFT证实回执状态节点仅对外汇掉期和拆借交易显示
4. SWIFT证实回执状态节点内部严格遵循 RMC → FTM 的串行逻辑
5. RMC 失败时，大节点状态置为"回执失败"，界面高亮报错，明确标注"无后续回执"
6. RMC 失败时，不显示 FTM 子节点
7. FTM 失败时，大节点状态置为"发送失败"，触发"待办补发"提醒
8. 对于每个节点和子节点，清晰显示当前状态和时间戳
9. 自动匹配失败时，状态转为"手工处理"，提供操作指引
10. 交易删除后，流程标记为终结，进入归档库
11. 失败或阻塞的节点明确标注原因和操作指引
12. 提供可视化的进度条，直观展示三个主要节点和当前位置
13. SWIFT证实回执状态节点展开显示RMC和FTM两个子节点的状态
14. 状态信息实时更新，延迟不超过10秒
15. 进度组件嵌入在交易信息标签页底部，与页面风格一致
16. 操作指引根据不同状态动态显示（正常指引/RMC失败指引/FTM失败指引）

### 功能7: 结算支付进度跟踪

#### 1. 功能点描述
根据现金流当前所处的结算支付阶段，实时跟踪从清算轧差到账务入账的完整流程，以可视化方式展示结算执行的完成情况。该功能涵盖清算轧差、合规准入、结算执行与回执、异常补偿四个核心阶段。

**展示位置**:
- 在交易详情页面的"现金流信息"标签页底部展示结算支付进度跟踪组件
- 进度跟踪组件应该嵌入在现金流信息内容区域内，而不是作为独立的标签页

#### 2. 前提与约束
- 用户必须具有进度查看权限
- 流程严格按照预定义的四个阶段顺序执行
- 不同产品类型（外汇/拆借 vs 现券/回购）有不同的前置触发条件
- 不同发送路径（SWIFT vs CBMNet）有不同的处理逻辑
- 某些阶段失败会硬性阻断后续流程
- 进度组件应该与页面内容自然融合，保持一致的视觉风格

#### 3. 输入描述
- **现金流内部ID** (必填): 字符串，要查询进度的现金流标识

#### 4. 输出描述
成功时返回：

**当前进度信息**:
- **当前阶段**: 现金流所处的具体阶段名称（清算轧差/合规准入/结算执行/异常补偿）
- **当前状态**: 当前阶段的状态（待处理/处理中/成功/失败/待审批/已阻断）
- **发送路径**: 标识使用的结算通道（SWIFT/CBMNet/内部账）

**阶段1: 清算轧差 (Netting & Settlement Instruction)**

**目标**: 确定结算头寸与最终收付指令

**前置触发校验**:
- **外汇/拆借**: 需满足证实匹配成功
- **现券/回购**: 需满足文本证实通过

**处理路径**:

1. **自动轧差**:
   - 触发条件：日终批处理时自动执行
   - 处理逻辑：系统按交易对手、币种、结算日自动合并
   - 输出结果：生成收付记录
   - 状态：自动轧差完成

2. **手工轧差/重组**（异常/特殊需求）:
   - 触发条件：结算员在UI界面手动勾选多笔成交记录
   - 处理逻辑：执行"手工轧差"或"重组"操作
   - 输出结果：生成净额结算指令
   - 状态：手工轧差完成

**输出状态**: 待发报 (Pending Dispatch)

**阶段2: 合规准入 (Compliance Gateway)**

**目标**: 在指令出库前进行风险拦截

**合规硬拦截**:

1. **自动校验**:
   - 校验项：实时对接反洗钱（AML）和黑名单扫描
   - 处理结果：
     - 校验通过：继续后续流程
     - 校验失败/待定：系统硬性阻断，状态更新为"禁止发报"
   - 状态：合规校验中/合规通过/合规拦截

2. **报文发送路径决策**:
   - 决策依据：系统根据SSI（标准结算指令）参数自动判断
   - 目标通道：SWIFT、CBMNet等
   - 状态：路径已确定

3. **人工审批流**（如配置为人工处理）:
   - 触发条件：结算报文配置为人工处理
   - 处理逻辑：触发收付审批流程
   - 审批结果：
     - 审批通过：方可执行发报
     - 审批拒绝：流程终止
   - 状态：待审批/审批通过/审批拒绝

**阶段3: 结算执行与回执 (Settlement Execution & Acknowledgement)**

**前置条件**: 发送路径已确定

**路径A: 发送路径 = SWIFT**

这是最核心的严谨性环节，必须遵循线性顺序，一旦失败则流程中断。

**A. 传输层回执 (Transmission Layer)**

必须遵循线性顺序，一旦失败则流程中断：

1. **发送RMC**:
   - 状态：RMC发送中
   - 成功：触发FTM处理
   - 失败：状态标记为"发送失败"，需人工介入排查
   - 操作指引：报文出口受阻（RMC失败），请检查报文规范

2. **触发FTM**:
   - 前提条件：RMC必须成功
   - 状态：FTM发送中
   - 成功：报文正式出库
   - 失败：记录失败日志，需人工介入排查
   - 操作指引：报文传输中断（FTM失败），请在待办中执行"补发处理"

**B. 账务层回执 (Accounting Layer)**

报文出库后，需同步完成核心扣划账处理：

1. **执行动作**:
   - 自动模式：系统自动将账务信息推送至核心系统
   - 手动模式：由结算员手动触发推送
   - 状态：核心入账处理中

2. **入账判定**:
   - 回执入账成功：结算单最终状态更新为"结算完成 (Settled)"
   - 回执入账失败：显示失败原因，系统强制跳转至【内部账划转查询】界面
   - 回执入账不明：显示不明状态，系统强制跳转至【内部账划转查询】界面
   - 操作指引：由人工进行冲正或其他操作。

**路径B: 发送路径 = CBMNet**

1. **人工确认**:
   - 触发条件：系统判定发送路径为CBMNet
   - 处理逻辑：需要人工进行确认
   - 确认结果：
     - 确认通过：进行核心扣划账
     - 确认拒绝：流程终止
   - 状态：待人工确认/确认通过/确认拒绝

2. **核心扣划账**:
   - 执行动作：确认通过后，系统将账务信息推送至核心系统
   - 入账判定：同SWIFT路径的账务层回执处理逻辑
   - 状态：核心入账处理中/结算完成/入账失败/入账不明


**阶段4: 结算撤销 (Cancellation)**

**目标**: 确保撤销逻辑与资金冲正的闭环

**触发场景**: 发报后发现错误，需发送撤销报文（如camt.056/058）

**撤销流控**（仅适用于SWIFT路径）:

1. **撤销报文发送**:
   - 发送RMC：
     - 成功：触发FTM处理
     - 失败：标记为"撤销发送失败"，需人工介入
   - 触发FTM：
     - 成功：撤销报文正式出库
     - 失败：记录失败日志，需人工介入

2. **核心入账处理**:
   - 执行动作：系统将撤销信息推送至核心系统进行资金冲正
   - 冲正判定：
     - 资金冲正成功：该笔原业务允许释放或重新处理
     - 资金冲正失败：需人工介入处理，防止资金头寸虚增或虚减
   - 状态：撤销处理中/撤销成功/撤销失败

**撤销流控**（CBMNet路径）:

1. **核心冲正处理**:
   - 执行动作：直接将撤销信息推送至核心系统进行资金冲正
   - 冲正判定：同SWIFT路径的核心入账处理逻辑
   - 状态：撤销处理中/撤销成功/撤销失败


未找到记录时返回：
- **错误信息**: "未找到对应的现金流记录"

#### 5. 验收标准
1. 系统能够准确识别现金流当前所处的结算支付阶段（清算轧差/合规准入/结算执行/结算撤销）
2. 流程严格按照预定义的四个阶段顺序展示
3. 清算轧差阶段能够正确判断前置触发条件：
   - 外汇/拆借产品需满足证实匹配成功
   - 现券/回购产品需满足文本证实通过
4. 清算轧差阶段支持自动轧差和手工轧差/重组两种处理方式
5. 合规准入阶段能够实时对接反洗钱（AML）和黑名单扫描
6. 合规校验失败或待定时，系统硬性阻断后续流程，状态标记为"禁止发报"
7. 系统能够根据SSI参数自动判断并展示发送路径（SWIFT/CBMNet）
8. 人工审批流配置生效时，系统触发收付审批流程，审批通过后方可执行发报
9. SWIFT路径的传输层回执严格遵循RMC → FTM的串行逻辑
10. RMC发送失败时，状态标记为"发送失败"，明确标注"需人工介入排查"，并提供操作指引
11. RMC发送失败时，不触发FTM处理
12. FTM发送失败时，记录失败日志，状态标记为"发送失败"，提供"补发处理"操作指引
13. 账务层回执能够区分自动模式和手动模式
14. 核心入账成功时，结算单最终状态更新为"结算完成 (Settled)"
15. 核心入账失败或不明时，系统强制跳转至【内部账划转查询】界面，提供人工冲正操作指引
16. CBMNet路径需要人工确认，确认通过后方可进行核心扣划账
17. CBMNet路径的核心扣划账处理逻辑与SWIFT路径的账务层回执一致
18. 结算撤销流程（SWIFT路径）必须完整经历RMC → FTM → 核心冲正的全流程监控
19. 撤销报文发送失败时，标记为"撤销发送失败"，需人工介入
20. 资金冲正成功后，原业务才允许释放或重新处理，防止资金头寸虚增或虚减
21. 资金冲正失败时，需人工介入处理
22. CBMNet路径的撤销流程直接进行核心冲正处理
23. 对于每个阶段和子节点，清晰显示当前状态和时间戳
24. 失败或阻断的节点明确标注原因和操作指引
25. 提供可视化的进度条，直观展示四个主要阶段和当前位置
26. 已完成节点标记为绿色，当前节点标记为蓝色并高亮，未完成节点标记为灰色，失败节点标记为红色，阻断节点标记为红色并高亮，待审批节点标记为黄色
27. 状态信息实时更新，延迟不超过10秒
28. 进度组件嵌入在现金流信息标签页底部，与页面风格一致
29. 支持打印或导出进度报告
30. 未找到现金流记录时，返回明确的错误信息

### 功能8: 操作指引

#### 1. 功能点描述
基于交易和支付信息当前的生命周期状态，动态生成操作指引，明确告知用户当前状态和下一步应该执行的操作。操作指引统一采用"当前状态...下一步操作..."的格式，确保用户清晰了解流程位置和后续动作。

#### 2. 前提与约束
- 用户必须具有操作指引查看权限
- 操作指引基于当前状态动态生成
- 不同状态对应不同的操作建议
- 某些状态需要提供人工处理入口
- 操作指引需要区分交易进度跟踪和结算支付进度跟踪两个维度

#### 3. 输入描述
- **交易流水号** (必填): 字符串，要查询交易进度操作指引的交易标识
- **现金流内部ID** (可选): 字符串，要查询结算支付进度操作指引的现金流标识

#### 4. 输出描述
成功时返回：

**操作指引信息**:
- **当前状态**: 明确告知用户当前所处的状态
- **下一步操作**: 明确告知用户下一步应该做什么

**A. 交易进度跟踪操作指引（功能6相关）**

**场景1: 后台复核 - 复核中**
- 当前状态：交易已同步至后线，等待结算员核对交易要素与清算路径
- 下一步操作：请在"后线工作台 - 交易复核"中确认并进行审批

**场景2: 后台复核 - 交易已删除**
- 当前状态：交易已被删除
- 下一步操作：流程已终结

**场景3: SWIFT证实 - RMC发送中**
- 当前状态：系统正在发送RMC报文
- 下一步操作：请等待RMC回执

**场景4: SWIFT证实 - RMC发送失败**
- 当前状态：RMC回执失败，流程已阻断
- 下一步操作：请检查报文规范或寻求技术支持

**场景5: SWIFT证实 - FTM发送中**
- 当前状态：RMC回执成功，系统正在发送FTM报文
- 下一步操作：请等待FTM回执

**场景6: SWIFT证实 - FTM发送失败**
- 当前状态：FTM回执失败，报文传输中断
- 下一步操作：请进入"后线工作台 - 证实报文"中执行"补发"或其他操作

**场景7: 证实匹配 - 待匹配**
- 当前状态：SWIFT回执成功，等待系统或人工进行匹配处理
- 下一步操作：等待系统自动匹配

**场景8: 证实匹配 - 匹配中**
- 当前状态：系统正在对对手方报文进行自动打分
- 下一步操作：等待匹配结果

**场景9: 证实匹配 - 匹配成功**
- 当前状态：证实匹配成功
- 下一步操作：流程已完成，系统将自动进入收付发报流程

**场景10: 证实匹配 - 手工处理**
- 当前状态：自动匹配失败，需要结算员执行人工匹配或撤销处理
- 下一步操作：请进入"后线工作台 - 证实匹配"中进行手工匹配或其他操作

**B. 结算支付进度跟踪操作指引（功能7相关）**

**阶段1: 清算轧差**

**场景11: 清算轧差 - 待轧差**
- 当前状态：证实匹配通过
- 下一步操作：等待系统日终批处理自动轧差，或手动执行轧差操作

**场景12: 清算轧差 - 自动轧差完成**
- 当前状态：系统已完成自动轧差，生成收付记录
- 下一步操作：系统将自动进入合规准入阶段

**场景13: 清算轧差 - 手工轧差完成**
- 当前状态：已完成手工轧差，生成结算指令
- 下一步操作：系统将自动进入合规准入阶段

**阶段2: 合规准入**

**场景14: 合规准入 - 合规校验中**
- 当前状态：系统正在进行反洗钱和黑名单检查
- 下一步操作：等待反洗钱系统审核完成

**场景15: 合规准入 - 合规拦截**
- 当前状态：反洗钱检查失败，系统已硬性阻断后续流程
- 下一步操作：请联系相关部门或申请人工审核

**场景16: 合规准入 - 待审批**
- 当前状态：合规通过，报文需进行人工审批
- 下一步操作：请等待审批人员审批

**场景17: 合规准入 - 审批拒绝**
- 当前状态：审批人员拒绝审批，流程已终止
- 下一步操作：请联系审批人员

**场景18: 合规准入 - 路径已确定**
- 当前状态：合规通过，系统已确定发送路径（SWIFT/CBMNet）
- 下一步操作：系统将自动进入结算执行阶段

**阶段3: 结算执行与回执**

**场景19: 结算执行 - RMC发送中（SWIFT路径）**
- 当前状态：系统正在发送RMC报文
- 下一步操作：请等待RMC回执

**场景20: 结算执行 - RMC发送失败（SWIFT路径）**
- 当前状态：RMC发送失败，报文出口受阻
- 下一步操作：请检查RMC连接状态或联系技术支持

**场景21: 结算执行 - FTM发送中（SWIFT路径）**
- 当前状态：RMC发送成功，系统正在发送FTM报文
- 下一步操作：请等待FTM回执


**场景22: 结算执行 - FTM发送失败（SWIFT路径）**
- 当前状态：FTM发送失败，报文传输中断
- 下一步操作：请检查报文格式，在"后线工作台-证实报文"执行"补发"或其他操作

**场景23: 结算执行 - 待人工确认（CBMNet路径）**
- 当前状态：系统判定发送路径为CBMNet，需要人工确认
- 下一步操作：进行人工确认

**场景24: 结算执行 - 确认拒绝（CBMNet路径）**
- 当前状态：人工确认拒绝，流程已终止
- 下一步操作：请联系相关人员

**场景25: 结算执行 - 核心入账处理中**
- 当前状态：报文已出库，系统正在推送账务信息至核心系统
- 下一步操作：等待核心系统处理

**场景26: 结算执行 - 结算完成**
- 当前状态：核心入账成功，结算流程已完成
- 下一步操作：流程已完成，无需操作

**场景27: 结算执行 - 入账失败**
- 当前状态：核心入账失败，需要进行冲正或重试
- 下一步操作：请查询内部账划转情况

**场景28: 结算执行 - 入账不明**
- 当前状态：核心入账状态不明，需要人工确认
- 下一步操作：请查询内部账划转情况，确认入账状态

**阶段4: 结算撤销**

**场景29: 结算撤销 - 撤销RMC发送中（SWIFT路径）**
- 当前状态：系统正在发送撤销RMC报文
- 下一步操作：等待撤销RMC回执

**场景30: 结算撤销 - 撤销RMC发送失败（SWIFT路径）**
- 当前状态：撤销RMC发送失败
- 下一步操作：请检查连接状态或联系技术支持


**场景31: 结算撤销 - 撤销FTM发送中（SWIFT路径）**
- 当前状态：撤销RMC成功，系统正在发送撤销FTM报文
- 下一步操作：等待撤销FTM回执

**场景32: 结算撤销 - 撤销FTM发送失败（SWIFT路径）**
- 当前状态：撤销FTM发送失败
- 下一步操作：检查报文格式，重新发送

**场景33: 结算撤销 - 撤销处理中**
- 当前状态：撤销报文已出库，系统正在进行资金冲正
- 下一步操作：等待资金冲正完成

**场景34: 结算撤销 - 撤销成功**
- 当前状态：资金冲正成功，原业务允许释放或重新处理
- 下一步操作：流程已完成，可以释放或重新处理原业务

**场景35: 结算撤销 - 撤销失败**
- 当前状态：资金冲正失败，需要人工介入处理
- 下一步操作：请查询内部账划转情况


未找到记录时返回：
- **错误信息**: "未找到对应的交易或现金流记录"

#### 5. 验收标准
1. 操作指引动态生成，统一采用"当前状态...下一步操作..."的格式
2. 明确区分交易进度跟踪和结算支付进度跟踪两个维度的操作指引
3. 对于每个场景，清晰显示当前状态、下一步操作、操作入口、注意事项和预计时间
4. 对于需要人工处理的情况，提供明确的操作入口（按钮/链接）
5. 操作入口可点击，能够跳转到相应的功能页面
6. 注意事项清晰明确，帮助用户正确执行操作
7. 预计时间准确，帮助用户合理安排工作
8. 操作指引实时更新，与生命周期状态保持同步
9. 操作指引加载时间在正常负载下不超过200毫秒
10. 覆盖功能6和功能7中定义的所有关键状态场景
11. 阻断状态（如RMC失败、合规拦截）明确标注流程已阻断
12. 终结状态（如交易已删除、审批拒绝）明确标注流程已终止
13. 正常流转状态提供清晰的下一步预期

### 功能9: 数据持久化与并发控制

#### 1. 功能点描述
确保所有交易数据、事件记录和账务信息持久化存储，并通过并发控制机制保证数据一致性和完整性。

#### 2. 前提与约束
- 所有数据操作必须持久化到数据库
- 支持事务处理，保证数据一致性
- 使用乐观锁或悲观锁机制防止并发冲突
- 查询操作不加锁，允许并发读取
- 更新操作需要获取锁

#### 3. 输入描述
无直接用户输入，系统自动处理数据持久化和并发控制

#### 4. 输出描述
正常操作：
- 操作正常完成，无额外输出

持久化失败：
- **错误代码**: 数据库错误代码
- **错误信息**: 详细的错误描述
- **回滚状态**: 确认操作已回滚

并发冲突：
- **错误代码**: CONCURRENT_CONFLICT
- **错误信息**: "记录正在被其他用户修改，请稍后重试"
- **冲突的记录标识**: 交易流水号
- **建议重试时间**: 建议的重试等待时间（秒）

#### 5. 验收标准
1. 所有数据操作立即持久化到数据库
2. 系统重启后能够完整恢复所有数据
3. 数据持久化失败时，系统回滚内存操作并返回错误信息
4. 多个用户同时更新同一条记录时，系统使用锁机制确保数据一致性
5. 检测到并发冲突时，系统返回冲突错误信息并提示用户重试
6. 多个用户同时查询时，系统允许并发读取操作而不加锁
7. 支持数据库事务，确保复杂操作的原子性
8. 系统能够处理至少50个并发用户的同时访问

## 非功能性需求

### 性能要求
- 交易汇总查询响应时间 < 500ms（1000条记录以内）
- 交易详情加载时间 < 300ms
- 事件信息查询响应时间 < 200ms
- 账务信息查询响应时间 < 200ms
- 导出功能响应时间 < 30秒（1000条记录）
- 该功能模块支持至少50个并发用户
- 分页切换响应时间 < 200ms

### 可用性要求
- 功能可用性与GIT-RG系统整体可用性保持一致
- 支持7x24小时运行
- 界面响应流畅，无明显卡顿
- 支持主流浏览器（Chrome、Firefox、Safari、Edge最新版本）

### 安全性要求
- 所有操作需要通过GIT-RG系统的统一身份认证
- 不同功能模块需要相应的权限验证（查询权限、导出权限等）
- 所有操作记录到GIT-RG系统的审计日志
- 数据传输使用GIT-RG系统的加密协议
- 事件记录和账务信息不可修改或删除，保证审计完整性

### 可扩展性要求
- 支持与GIT-RG系统其他模块的数据集成
- 支持新增产品类型和交易状态
- 数据库设计支持未来扩展新的查询维度和字段
- 支持扩展新的导出格式

### 兼容性要求
- 与GIT-RG系统的UI框架保持一致
- 遵循GIT-RG系统的RESTful API规范
- 支持JSON数据格式
- 界面布局适配不同分辨率（最低支持1366x768）
- API版本化管理，向后兼容

